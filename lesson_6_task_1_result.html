<!--
2. 1. Доработать модуль корзины.

a. Добавлять в объект корзины выбранные товары по клику на кнопке «Купить» без перезагрузки страницы

b. Привязать к событию покупки товара пересчет корзины и обновление ее внешнего вида
 -->


<!-- Основная сложность возникла с кнопками. Очень долго думал как привязать товар к кнопке. Выбрал JSON. 
Также не получалось делегирование события по кнопке 'В корзину'. Ну и напоследок конткретно так застрял на обновлении вида корзины, с тем чтобы корректно отображаласть позиция с одинаковыми товарами. -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Catalog_Basket</title>
    <!-- <script src="script.js" defer></script> -->
</head>

<body>
    <div id="catalog"></div>
    <div id="basket"></div>
    <button class="cart-btn">Очистить корзину</button>

    <script>
        const basket = {
            products_in_basket: [],
            duplicatesIndices: [],
            no_duplicate_prod_in_basket: [],

            cartButton: null,

            addTobasket(prod) {
                this.duplicateProduct(prod, this.products_in_basket);
                return this.products_in_basket

            },

            // Данный метод необходим для отображения количества, суммарной стоимости позиции одинаковых товаров в корзине(чтобы в Корзине был не тупо список товаров с количеством равным 1)
            duplicateProduct(some_prod, objectArray) {
                let isInArray = false;
                let objectsItter = [];
                if (objectArray.length === 0) {
                    isInArray = true
                    return objectArray.push(some_prod),
                        console.log(isInArray);
                };
                objectArray.forEach((object) => {
                    isInArray === false
                    objectsItter.push(object)
                    console.log(objectsItter);
                    if (some_prod.id === object.id) {
                        object.count += 1;
                        isInArray = true;
                        console.log(isInArray);
                        console.log('CLick Dupl');
                        return objectArray;
                    };
                },
                );
                if (isInArray === false) {
                    console.log('Click Unique');
                    objectArray.push(some_prod);
                };
            },


            delFrombasket(prod) {
                for (let i = 0; i < this.products_in_basket.length; i++) {
                    if (prod.id === this.products_in_basket[i].id) {
                        this.products_in_basket.splice(i, 1);
                        break;
                    }
                }
                return this.products_in_basket
            },

            countBasketPrice() {

                i = 0
                if (i < this.products_in_basket.length) {
                    let result = this.products_in_basket.reduce(function (sum, current) {
                        current = current.price * current.count
                        i++
                        return sum + current;
                    }, 0);
                    return result
                }
            },

            clearCart() {
                this.products_in_basket = [];
                this.createBasket();
            },

            // Нужно сделать декомпозицию. Слишком нагруженный метод получился.
            createBasket() {

                let myDiv = document.getElementById(`basket`);
                myDiv.innerHTML = '' // Очистка предыдущего состояния корзины!Без этого все состояния   отражаются на странице   
                if (this.products_in_basket.length === 0) {
                    const h2tag = document.createElement('h1');
                    h2tag.style.color = 'blue';
                    h2tag.textContent = 'Корзина пуста';
                    myDiv.appendChild(h2tag)
                    this.cartButton = document.querySelector('.cart-btn').hidden = true; // скрываем кнопку
                    return myDiv
                };
                const h1tag = document.createElement('h1');
                myDiv.appendChild(h1tag);
                h1tag.style.color = 'blue';
                h1tag.textContent = 'Корзина';


                myDiv.appendChild(render(this.products_in_basket, ['name', 'price', 'count', 'total'], ['Наименование', 'Цена, руб.', 'Количество, шт', 'Стоимость позиции, руб.']));

                document.querySelector('.cart-btn').hidden = false;
                this.cartButton = document.querySelector('.cart-btn');
                this.cartButton.addEventListener('click', this.clearCart.bind(this));

                myDiv.appendChild(document.createElement('br'));
                myDiv.appendChild(document.createTextNode(`В корзине: ${this.products_in_basket.reduce(function (p, c) { return +p + +c.count; }, '')} 
                товар(-а,-ов)  на сумму ${this.countBasketPrice()} руб.`));
                return myDiv
            },
        }

        const catalog = {
            products: [],
            cart: null,
            btnsInBasket: null,

            addToCatalog(prod) {
                this.products.push(prod)
                return this.products
            },

            delFromCatalog(prod) {
                for (let i = 0; i < this.products.length; i++) {
                    if (prod.id === this.products[i].id) {
                        this.products.splice(i, 1);
                        break;
                    }
                }
                return this.products
            },

            createCatalog() {
                this.addToCatalog(product_1);
                this.addToCatalog(product_2);
                this.addToCatalog(product_3);
                const h1tag = document.createElement('h1')
                h1tag.style.color = 'red'
                h1tag.textContent = 'Каталог'
                let myDiv = document.getElementById(`catalog`);
                myDiv.appendChild(h1tag)
                myDiv.appendChild(render(this.products, ['id', 'name', 'price', 'inBasket'], ['id', 'Наименование', 'Цена, руб.', '']));
                return myDiv
            },

            // Инициализация корзины. 
            init(cart) {
                this.cart = cart;
                this.btnsInBasket = document.querySelectorAll('.inBasket');
                this.btnsInBasket.forEach(button => button.addEventListener('click', this.addToCart.bind(this)));
                this.cart.createBasket();

            },
            // Добавление товаров в корзину и возврат нового состояния корзины.
            addToCart() {
                this.cart.addTobasket(this.prodToBasket());
                return this.cart.createBasket();
            },
            // Поиск товара к добалению в корзину.
            prodToBasket() {
                const some_prod = JSON.parse(event.target.dataset.prod)
                return some_prod


            }
        }


        function render(objectArray, fields, fieldTitles) {
            let tbl = document.createElement('table');
            tbl.setAttribute('border', '1');
            tbl.setAttribute('bordercolor', 'grey')
            let thead = document.createElement('thead');
            thead.style.color = 'red';
            let thr = document.createElement('tr');
            fieldTitles.forEach((fieldTitle) => {
                let th = document.createElement('th');
                th.appendChild(document.createTextNode(fieldTitle));
                thr.appendChild(th);
            });
            thead.appendChild(thr);
            tbl.appendChild(thead);

            let tbdy = document.createElement('tbody');
            let tr = document.createElement('tr');
            for (let i = 0; i < objectArray.length; i++) {
                let tr = document.createElement('tr');
                fields.forEach((field) => {
                    let td = document.createElement('td');
                    if (field == 'total') {
                        td.textContent = `${objectArray[i].price * objectArray[i].count}`
                    } else {
                        td.textContent = `${objectArray[i][field]}`;
                    };
                    if (field == 'inBasket') {
                        td = document.createElement('button')
                        let textInBtn = document.createTextNode('В корзину');
                        td.classList.add('inBasket')
                        td.dataset.prod = JSON.stringify(objectArray[i]) // записываем в data строковое представление объекта Product, соответвующего данной кнопке.Используется в методе     catolog.prodToBasket() - где парсится и через catalog.addToCart(prod) добавляется в корзину.
                        td.appendChild(textInBtn)
                    };

                    tr.appendChild(td);
                });
                tbdy.appendChild(tr);
            };
            tbl.appendChild(tbdy);

            return tbl;
        }

        let product_1 = {
            id: 1,
            name: 'iphone',
            price: 99000,
            count: 1
        };

        let product_2 = {
            id: 2,
            name: 'macbook',
            price: 149999,
            count: 1
        };

        let product_3 = {
            id: 3,
            name: 'Macbook case',
            price: 10000,
            count: 1
        };

        catalog.createCatalog();
        catalog.init(basket);
    </script>
</body>

</html>